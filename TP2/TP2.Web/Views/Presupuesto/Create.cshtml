@model TP2.Entidades.EF.T_GUQ_PRESUPUESTO

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



@section Scripts {

@Scripts.Render("~/Script/jqueryui")
@Styles.Render("~/Content/cssjqryUi")

<script type="text/javascript">
    $(function () {
        $('#anio').datepicker({
            changeYear: true,
            showButtonPanel: true,
            dateFormat: 'yy',
            onClose: function (dateText, inst) {
                $(this).datepicker('setDate', new Date(inst.selectedYear, 1));
            }
        });
    });

    $(document).ready(function () {

        $("#btnCrear").click(function () {
            var anio = $("#anio").val();
            var partida = $('#partida').val();
            var idArea = $('#idArea').val();
            $.ajax({
                url: "/Presupuesto/Create",
                type: 'POST',
                data: {
                    anio: anio, partida: partida, idArea: idArea
                },
                success: function (data) {
                    alert(data);
                    if (data.indexOf("Error") == -1) {
                        window.location.href = '/Presupuesto';
                    }
                },
                error: function (error) {
                    alert("Error: Intente de nuevo.");
                }
            });
        });

        

        $("#btnAgregarPartida").on("click", function () {
           
            var anio = $("#anio").val();
            var partida = $('#partida').val();
            var idArea = $('#idArea').val();
            $.ajax({
                url: "/Presupuesto/AgregarPartida",
                type: 'POST',
                data: {
                    anio: anio, partida: partida, idArea: idArea
                },
                success: function (data) {
                    
                    if (data == "Error") {
                        alert("Usted ya agrego esa  partida");
                    } else {
                        EliminarFilas();
                        for (var i = 0; i < data.length; i++) {
                            var tds = tds += '<tr class = "filas">';
                            tds += '<td>' + data[i].idPartida + '</td>';
                            tds += '<td>' + data[i].descripcion + '</td>';
                            tds += '<td>' + data[i].monto + '</td>';
                            tds += '<td><button   class = "EditarPartida" > Editar </button> </td>';
                            tds += '<td><button  class = "EliminarPartida" > Eliminar </button> </td>';
                            tds += '</tr>';

                        }
                        $("#tblPartida").append(tds);

                        $(".EditarPartida").off("click");
                        $(".EditarPartida").on("click", function () {
                            var id = $(this).parents("tr").find("td").eq(0).html();
                            EditarPartidaGet(id);
                        });

                        $(".EliminarPartida").off("click");
                        $(".EliminarPartida").on("click", function () {
                            var id = $(this).parents("tr").find("td").eq(0).html();
                            EliminarPartidas(id);
                        });
                    }
                    
                   
                },
                error: function (error) {
                    alert("Error: Intente de nuevo.");
                }
            });
        });


        $("#partida").change(function () {

            var partida = $("#partida option:selected").val();
            var idArea = $('#idArea').val();
            var anio = $("#anio").val();
            $.ajax({
                url: "/EstadisticaRecursos/Index",
                type: 'POST',
                data: {
                    anio: anio, partida: partida, idArea: idArea
                },
                success: function (data) {
                    $("#monto").val(data);
                   
                },
                error: function (error) {
                   
                }
            });
        });

        $("#btnActualizar").click(function () {

            var monto = $('#mont').val();
            var idPartida = $('#id').val();
  
            $.ajax({
                url: "/Presupuesto/EditarPartida",
                type: 'POST',
                data: {
                    monto: monto, idPartida: idPartida
                },
                success: function (data) {
                    EliminarFilas();
                    for (var i = 0; i < data.length; i++) {
                        var tds = tds += '<tr class = "filas">';
                        tds += '<td>' + data[i].idPartida + '</td>';
                        tds += '<td>' + data[i].descripcion + '</td>';
                        tds += '<td>' + data[i].monto + '</td>';
                        tds += '<td><button   class = "EditarPartida" > Editar </button> </td>';
                        tds += '<td><button  class = "EliminarPartida" > Eliminar </button> </td>';
                        tds += '</tr>';

                    }
                    $("#tblPartida").append(tds);

                    $(".EditarPartida").off("click");
                    $(".EditarPartida").on("click", function () {
                        var id = $(this).parents("tr").find("td").eq(0).html();
                        EditarPartidaGet(id);
                    });

                    $(".EliminarPartida").off("click");
                    $(".EliminarPartida").on("click", function () {
                        var id = $(this).parents("tr").find("td").eq(0).html();
                        EliminarPartidas(id);
                    });

                    $('#modalEditarPartida').modal('hide');
                },
                error: function (error) {
                    alert("Error: Intente de nuevo.");
                }
            });
        });
        
   

    });

    function EliminarFilas() {
        $("tbody").empty();
        $(".filas").remove();

       
    }

    function EditarPartidaGet(id) {
        
        $.ajax({
            url: "/Presupuesto/EditarPartida",
            type: 'GET',
            data: {
                idPartida: id
            },
            success: function (data) {
                $('#id').val(data.idPartida);
                $('#desc').val(data.descripcion);
                $('#mont').val(data.monto);
                $('#modalEditarPartida').modal('show');

            },
            error: function (error) {
                alert("Error: Intente de nuevo.");
            }
        });
    }

    function EliminarPartidas(id) {
        if (confirm("¿Esta seguro de eliminar el registro?")) {
            $.ajax({
                url: "/Presupuesto/EliminarPartida",
                type: 'POST',
                data: {
                    idPartida: id
                },
                success: function (data) {

                    EliminarFilas();
                    for (var i = 0; i < data.length; i++) {
                        var tds = tds += '<tr class = "filas">';
                        tds += '<td>' + data[i].idPartida + '</td>';
                        tds += '<td>' + data[i].descripcion + '</td>';
                        tds += '<td>' + data[i].monto + '</td>';
                        tds += '<td><button   class = "EditarPartida" > Editar </button> </td>';
                        tds += '<td><button  class = "EliminarPartida" > Eliminar </button> </td>';
                        tds += '</tr>';

                    }
                    $("#tblPartida").append(tds);

                    $(".EditarPartida").off("click");
                    $(".EditarPartida").on("click", function () {
                        var id = $(this).parents("tr").find("td").eq(0).html();
                        EditarPartidaGet(id);
                    });

                    $(".EliminarPartida").off("click");
                    $(".EliminarPartida").on("click", function () {
                        var id = $(this).parents("tr").find("td").eq(0).html();
                        EliminarPartidas(id);
                    });

                },
                error: function (error) {
                    alert("Error: Intente de nuevo.");
                }
            });
        }
      
    }

</script>

}

<style>
    .ui-datepicker-calendar {
        display: none;
    }
</style>



    <div class="form-horizontal">
        <h4>T_GUQ_PRESUPUESTO</h4>
        <hr />
      
        <div class="row">

         
            <div class="col-sm-6">
                <label class="mr-sm-2" for="fecha">Fecha:</label>
                <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                    <span class="input-group-addon"><span class=" glyphicon glyphicon-calendar"></span></span>
                    @Html.TextBox("anio", null, new { @class = "form-control" })
                </div>
            </div>

            <div class="col-sm-6">
                <label class="mr-sm-2" for="TipoOperacionList">Partida:</label>
                <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-list"></span></span>
                    @Html.DropDownList("partida", new SelectList(ViewBag.PartidaList, "idPartida", "dscPartida"), "--Seleccione una partida--", new { @class = "form-control" })
                </div>
            </div>

            <div class="col-sm-6">
                <label class="mr-sm-2" for="TipoOperacionList">Area:</label>
                <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-list"></span></span>
                    @Html.DropDownList("idArea", new SelectList(ViewBag.AreaList, "idArea", "descripcion"), "--Seleccione un área--", new { @class = "form-control" })
                </div>
            </div>

            <div class="col-sm-6">
                <label class="mr-sm-2" for="fecha">Monto:</label>
                <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                    <span class="input-group-addon"><span class=" glyphicon glyphicon-calendar"></span></span>
                    @Html.TextBox("monto", null, new { @class = "form-control", @readonly = "true" })
                </div>
            </div>

        </div>
        <br />
        <br />

        <div class="row" style="margin-top:10px;">
            <div class="col-sm-6">
                <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                    <input type="button" value="Agregar Partida" class="btn btn-default" id="btnAgregarPartida" />
                </div>
            </div>

            <div class="row" style="margin-top:10px;">
                <div class="col-sm-6">
                    <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                        <input type="button" value="Grabar" class="btn btn-default" id="btnCrear" />
                    </div>
                </div>
            </div>
        </div>

        
    </div>

<div class="row" id="Partidas">
    <div class="col-md-12">
        <table class="table table-bordered" id="tblPartida">
            <thead>
                <tr>
                    <th>Codigo</th>
                    <th>Descripcion</th>
                    <th>Monto</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
            
        </table>
    </div>
</div>



<div>
    @Html.ActionLink("Regresar atras", "Index")
</div>


<!-- Modal -->
<div id="modalEditarPartida" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Editar Partida</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="id">Id:</label>
                        <input type="text" class="form-control" id="id">
                    </div>
                    <div class="form-group">
                        <label for="pwd">Descripción:</label>
                        <input type="text" class="form-control" id="desc">
                    </div>
                    <div class="form-group">
                        <label for="pwd">Monto:</label>
                        <input type="text" class="form-control" id="mont">
                    </div>
                    
                    <button type="button" class="btn btn-default" id="btnActualizar">Actualizar</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

